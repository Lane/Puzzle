Array.prototype.remove=function(e,t){var n=this.slice((t||e)+1||this.length);return this.length=e<0?this.length+e:e,this.push.apply(this,n)};var RAD2DEG=180/Math.PI,DEG2RAD=1/RAD2DEG,PuzzleBox=PuzzleBox||{};PuzzleBox.Event=function(e){this._sender=e,this._listeners=[]};var ep=PuzzleBox.Event.prototype;ep.attach=function(e){this._listeners.push(e)},ep.notify=function(e){var t;for(t=0;t<this._listeners.length;t+=1)this._listeners[t](this._sender,e)};var PuzzleBox=PuzzleBox||{};PuzzleBox.Boundary=function(e,t,n,r){this.top=t,this.left=e,this.width=n,this.height=r,this.initialize()};var bd=PuzzleBox.Boundary.prototype;bd.initialize=function(){this.set(this.left,this.top,this.width,this.height)},bd.set=function(e,t,n,r){return this.top=t,this.right=e+n,this.bottom=t+r,this.left=e,this.width=n,this.height=r,this.center={x:e+n/2,y:t+r/2},this},bd.setDimensions=function(e){return this.set(this.left,this.top,e.width,e.height)},bd.setPosition=function(e,t){return this.set(e,t,this.width,this.height)},bd.getTopLeft=function(){return{x:this.left,y:this.top}},bd.getCenter=function(){return this.center},bd.getDimensions=function(){return{width:this.width,height:this.height}},bd.isEqual=function(e){return typeof e.top!="undefined"&&typeof e.left!="undefined"&&typeof e.width!="undefined"&&typeof e.height!="undefined"&&this.top==e.top&&this.left==e.left&&this.width==e.width&&this.height==e.height?!0:!1},bd.extendBoundary=function(e){return e.top<this.top&&(this.top=e.top),e.right>this.right&&(this.right=e.right),e.bottom>this.bottom&&(this.bottom=e.bottom),e.left<this.left&&(this.left=e.left),this.width=this.right-this.left,this.height=this.bottom-this.top,this.center={x:this.left+this.width/2,y:this.top+this.height/2},this};var PuzzleBox=PuzzleBox||{};PuzzleBox.PieceContainer=function(e){this._pieces=e.pieces||new Array,this._selected=!1,this._puzzle=null,this._snapped=!1,this.boundary=new PuzzleBox.Boundary(9999,9999,-19998,-19998),this.initialize(e)};var pc=PuzzleBox.PieceContainer.prototype=new createjs.Container;pc.Container_initialize=pc.initialize,pc.initialize=function(e){this.Container_initialize(e),this.name=e.name||"container"+this.id,this.cursor=e.cursor||"move",this.x=e.x||250,this.y=e.y||250,this._selected=!1,this._fixed=!1,this.type="piece-container";try{this._fixed=e.pieces[0].fixed,this._fixed&&(this.cursor="arrow")}catch(t){console.log(t),this._fixed=!1}this._fixed||(this.alpha=.8);for(var n=0;n<this._pieces.length;n++)if(typeof this._pieces[n].parent=="undefined"||this._pieces[n].parent==null){this._pieces[n].parent=this;if(this._pieces[n].parentX!=0||this._pieces[n].parentY!=0)this.x=this._pieces[n].parentX,this.y=this._pieces[n].parentY}this.setBoundary()},pc.setBoundary=function(){var e=new PuzzleBox.Boundary(9999,9999,-19998,-19998);for(var t=0;t<this._pieces.length;t++)e.extendBoundary(this._pieces[t].getPieceBoundary());if(e.width<1||e.height<1)e=new PuzzleBox.Boundary(0,0,1,1);var n=e.center;return this.boundary=e,this.boundary.top+=this.y-n.y,this.boundary.left+=this.x-n.x,this.boundary.bottom+=this.y-n.y,this.boundary.right+=this.x-n.x,this},pc.setCache=function(){var e=this.getPieceContainerBoundary();return this.cache(e.left,e.top,e.width,e.height),this},pc.getPieces=function(){return this._pieces},pc.getPieceString=function(){var e="";if(this._pieces.length==1)return this._pieces[0].displayName;for(var t=0;t<this._pieces.length;t++)t!==this._pieces.length-1?e+=this._pieces[t].displayName+", ":e+=this._pieces[t].displayName;return e},pc.getBoundingBox=function(){return this.boundary},pc.getPieceContainerBoundary=function(){return new PuzzleBox.Boundary(this.boundary.left-this.x+this.boundary.center.x,this.boundary.top-this.y+this.boundary.center.y,this.boundary.width,this.boundary.height)},pc.addPiece=function(e){this._pieces.push(e),e.parent=this,this.setBoundary();var t={x:this.regX,y:this.regY};this.regX=this.boundary.getCenter().x,this.regY=this.boundary.getCenter().y;var n={x:this.regX-t.x,y:this.regY-t.y};return this.x+=n.x,this.y+=n.y,this._puzzle.pieceAdded.notify({piece:e}),this},pc.movePiece=function(e,t){return this.x=e,this.y=t,this._snapped||(this.boundary.top=this.y-this.boundary.height/2,this.boundary.left=this.x-this.boundary.width/2,this.boundary.bottom=this.y+this.boundary.height/2,this.boundary.right=this.x+this.boundary.width/2),this},pc.rotatePiece=function(e){return this.rotation=e.start+(e.stageX-e.offset.x+(e.stageY-e.offset.y)),this},pc.removePiece=function(e){for(var t=0;t<this._pieces.length;t++)if(this._pieces[t].id==e.id)return this._pieces.remove(t),this._puzzle.pieceRemoved.notify({piece:e}),!0;return this.setBoundary(),!1},pc.selectPiece=function(){this._selected=!0,this.parent.addChild(this);for(var e=0;e<this._pieces.length;e++)this._pieces[e].image=this._pieces[e].imgSelected;return this},pc.hoverPiece=function(){if(!this._selected)for(var e=0;e<this._pieces.length;e++)this._pieces[e].image=this._pieces[e].imgHover;return this},pc.resetPiece=function(e){e=typeof e!="undefined"?e:!1;if(!this._selected||e){this._selected=!1;for(var t=0;t<this._pieces.length;t++)this._pieces[t].image=this._pieces[t].imgNeutral}return this},pc.matchPieces=function(){for(var e=0;e<this._pieces.length;e++){var t=this._pieces[e].getMatches();for(var n=0;n<t.length;n++)t[n].getPiece().parent.id!==t[n].getMatch().getPiece().parent.id?this._puzzle.connectPointWithMatch(t[n]):(t[n].getPiece().removePoint(t[n]),t[n].getMatch().getPiece().removePoint(t[n].getMatch())),debug.log(t[n],"Match has been made")}return this},pc.snapPiece=function(){return this.isMatched&&(this.resetPiece(!0),this._snapped&&createjs.Sound.play("snap").setVolume(.5)),this},pc.isMatched=function(){var e=!1;for(var t=0;t<this._pieces.length;t++)this._pieces[t].getMatches().length>0&&(e=!0);return e},pc.snapToMatch=function(){this._snapped=!1;for(var e=0;e<this._pieces.length;e++){var t=this._pieces[e].getMatches();if(t.length>0){var n=t[0],r=[n.getStageOffset(),n.getMatch().getStageOffset()],i={x:r[0].x-r[1].x,y:r[0].y-r[1].y};this.set({x:this.x-i.x,y:this.y-i.y}),this._snapped=!0,this.boundary.top=this.y-this.boundary.height/2,this.boundary.left=this.x-this.boundary.width/2,this.boundary.bottom=this.y+this.boundary.height/2,this.boundary.right=this.x+this.boundary.width/2}}return this},pc.isSelected=function(){return this._selected},pc.isFixed=function(){return this._fixed},pc.updatePoints=function(){for(var e=0;e<this._pieces.length;e++)for(var t=0;t<this._pieces[e]._points.length;t++)this._pieces[e]._points[t].updatePoint();return this},pc.updatePointsOffset=function(){for(var e=0;e<this._pieces.length;e++)for(var t=0;t<this._pieces[e]._points.length;t++)this._pieces[e]._points[t].setOffset();return this},pc.sortPieces=function(){this._pieces.sort(function(e,t){return e.zindex<t.zindex?-1:e.zindex>t.zindex?1:0})},pc.toString=function(){var e=this.boundary,t=this.name+"\n"+"Position: "+this.x+","+this.y+"\n"+"Rotation:"+this.rotation+"\n"+"Centre:"+this.regX+","+this.regY+"\n"+"Dimensions: "+e.width+","+e.height+"\n"+"Boundary: "+e.left+","+e.top+" : "+e.right+","+e.bottom+"\n";for(var n=0;n<this._pieces.length;n++)t+=this._pieces[n].toString();return t},pc.toHTMLString=function(){var e="<h3>"+this.name+"</h3>"+"<ul class='properties'>"+"<li><span>Position: </span>"+this.x+","+this.y+"</li>"+"<li><span>Rotation:</span>"+this.rotation+"</li>"+"<li><span>Centre: </span>"+this.regX+","+this.regY+"</li>"+"<li><span>Dimensions: </span>"+this.boundary.width+","+this.boundary.height+"</li>"+"<li><span>Boundaries: </span>"+this.boundary.left+","+this.boundary.top+" : "+this.boundary.right+","+this.boundary.bottom+"<li>";for(var t=0;t<this._pieces.length;t++)e+=this._pieces[t].toHTMLString();return e+="</li></ul>",e};var PuzzleBox=PuzzleBox||{};PuzzleBox.Piece=function(e){this._points=e.points||new Array,this.scaleX=this.scaleY=this.scale=e.scale||1,this.x=e.x||0,this.y=e.y||0,this.displayName=e.displayName||"Unnamed Piece",this.zindex=e.zindex||1,typeof e.fixed!="undefined"&&(this.fixed=!0),this.parentX=e.parentX||0,this.parentY=e.parentY||0,this.snapRadius=e.snapRadius||25,this.type="piece",e.name!==null&&(this.name=e.name),this.boundary=e.boundary||new PuzzleBox.Boundary(9999,9999,-19998,-19998),this.initialize(e)};var p=PuzzleBox.Piece.prototype=new createjs.Bitmap;p.Bitmap_initialize=p.initialize,p.initialize=function(e){var t,n=this;typeof e.img=="undefined"&&typeof e.imgSrc!="undefined"?(t=new Image,t.src=e.imgSrc,t.onload=function(e){n.Bitmap_initialize(this),n.setAttributes()}):typeof e.img!="undefined"&&typeof e.imgSrc=="undefined"&&(t=e.img,this.Bitmap_initialize(t),this.setAttributes()),typeof t=="undefined"&&debug.warn("Made a piece without an image."),debug.log("Created Piece:",this)},p.setAttributes=function(){this.regX=this.image.width/2|0,this.regY=this.image.height/2|0,this.setBoundary();try{var e=this.getParentPieceContainer();e.setBoundary(),e.parent._needsUpdate=!0}catch(t){debug.warn("This Piece has no parent, every piece should have a parent PieceContainer",this,t)}return this},p.setBoundary=function(){var e=this.x-Math.round(this.image.width*this.scaleX/2),t=this.y-Math.round(this.image.height*this.scaleY/2),n=Math.round(this.image.width*this.scaleX),r=Math.round(this.image.height*this.scaleY);return this.boundary.set(e,t,n,r),this},p.getPieceBoundary=function(){return this.boundary},p.getParentPieceContainer=function(){try{return this.parent}catch(e){return debug.warn("Trying to access parent of a Piece, but it has not been set",this,e),null}},p.getPoints=function(){return this._points},p.getMatches=function(){var e=new Array;for(var t=0;t<this._points.length;t++)this._points[t].isMatched()&&e.push(this._points[t]);return e},p.addPoint=function(e){return this._points.push(e),e.setPiece(this),this},p.hasPoint=function(e){for(var t=0;t<this._points.length;t++)if(this._points[t].isEqual(e))return!0;return!1},p.updatePoints=function(){for(var e=0;e<this._points.length;e++)this._points[e].updatePoint();return this},p.removePoint=function(e){for(var t=0;t<this._points.length;t++)this._points[t]==e&&this._points.remove(t);return this},p.removeAllPoints=function(){return this._points=new Array,this},p.isEqual=function(e){return this.id==e.id?!0:!1},p.toString=function(){var e=this.name+"\n"+"Position: "+this.x+","+this.y+"\n"+"Rotation: "+this.rotation+"\n"+"Centre: "+this.regX+","+this.regY+"\n"+"Scale: "+this.scaleX+","+this.scaleY+"\n";typeof this.image!="undefined"&&(e+="Image Dimensions: "+this.image.width+"x"+this.image.height+"\n");for(var t=0;t<this._points.length;t++)e+=this._points[t].toString();return e+="\n",e},p.toHTMLString=function(){var e="<h4>"+this.name+"</h4>"+"<ul class='properties'>"+"<li><span>Position: </span>"+this.x+","+this.y+"</li>"+"<li><span>Rotation: </span>"+this.rotation+"</li>"+"<li><span>Centre: </span>"+this.regX+","+this.regY+"</li>"+"<li><span>Scale: </span>"+this.scaleX+","+this.scaleY+"</li>";typeof this.image!="undefined"&&(e+="<li>Image Dimensions: "+this.image.width+"x"+this.image.height+"</li>");for(var t=0;t<this._points.length;t++)e+="<li>"+this._points[t].toString()+"</li>";return e+="</ul>",e};var PuzzleBox=PuzzleBox||{};PuzzleBox.Point=function(e,t,n,r){this.x=t,this.y=n,this.piece=e||null,this.angle=0,this.radius=0,this.match=null,this._stageOffset={x:0,y:0},this.initialize()};var pt=PuzzleBox.Point.prototype;pt.initialize=function(){this.setAngle().setRadius().setOffset(),this.piece!==null&&this.piece.addPoint(this)},pt.setPosition=function(e){return this.x=e.x,this.y=e.y,this},pt.setMatch=function(e){return this.match=e,e.match=this,this},pt.setAngle=function(){return this.angle=this._calculateAngle(this.getOffsetFromOrigin()),this},pt.setRadius=function(){return this.radius=this._calculateRadius(this.getOffsetFromOrigin()),this},pt.setOffset=function(){var e=this._calculateRotatedCoordinates(this.getTotalRotation()),t={};return this.piece!==null?(ptpc=this.piece.getParentPieceContainer())?(t.x=ptpc.x+e.x,t.y=ptpc.y+e.y):debug.warn("No parent piece container when setting offset for point:",this):debug.warn("Stage offset may be incorrect because there is no parent piece for this point.",this),this._stageOffset=t,this},pt.setPiece=function(e){this.piece=e},pt.getPiece=function(){return this.piece},pt.getTotalRotation=function(){return typeof this.piece!="undefined"&&this.piece!==null?typeof this.piece.parent!="undefined"&&this.piece.parent!==null?this.piece.parent.rotation:(debug.warn("Rotation of point may be incorrect because the Point this Piece is associated with has no PieceContainer",this),0):(debug.warn("Rotation of point may be incorrect  because the Point this Piece is null",this),0)},pt.getStageOffset=function(){return this._stageOffset},pt.getParentOffset=function(){return{x:this.x+this.piece.x,y:this.y+this.piece.y}},pt.getMatch=function(){return this.match},pt.getOffsetFromOrigin=function(){try{var e={x:this.x+(this.piece.x-this.piece.parent.regX),y:this.y+(this.piece.y-this.piece.parent.regY)}}catch(t){debug.warn("Attempted to get offset of piece with no parent.",t);var e={x:this.x,y:this.y}}return e},pt.getRadius=function(){return this.radius},pt.getAngle=function(){return this.angle},pt.updatePoint=function(){return this.setAngle().setRadius().setOffset(),this},pt.isEqual=function(e){var t=!1;return this.x==e.x&&this.y==e.y&&(this.piece==null&&e.piece==null&&(t=!0,debug.warn("Points are equal, but may be flawed as they are not associated with a piece.",this,e)),this.piece!==null&&e.piece!==null&&this.piece.isEqual(e.piece)&&(t=!0)),t},pt.isMatched=function(){if(this.match==null)return debug.warn("Checking if there is a match for a point with no match"),!1;var e=Math.abs(this.getTotalRotation()%360-this.match.getTotalRotation()%360);if(e>45)return!1;var t=this.getStageOffset(),n=this.match.getStageOffset(),r={x:Math.abs(t.x-n.x),y:Math.abs(t.y-n.y)};return r.x>this.piece.snapRadius||r.y>this.piece.snapRadius?!1:!0},pt._calculateRotatedCoordinates=function(e){var t=this.angle-e,n={x:Math.round(Math.cos(t*DEG2RAD)*this.radius),y:Math.round(-1*Math.sin(t*DEG2RAD)*this.radius)};return n},pt._calculateAngle=function(e){var t=0,n=e,r=Math.atan(-n.y/n.x)*RAD2DEG;return n.y==0?n.x>=0?0:180:n.x==0?n.y<=0?90:270:n.x>0&&n.y<0?r:(n.x<0&&n.y<0&&(t=90),n.x<0&&n.y>0?180+r:(n.x>0&&n.y>0&&(t=270),90+r+t))},pt._calculateRadius=function(e){var t=e;return Math.sqrt(t.x*t.x+t.y*t.y)},pt.toString=function(){var e=[this.getStageOffset(),this.match.getStageOffset()],t="Point: <ul style='margin-left:10px;'><li>Stage Offset: "+e[0].x+","+e[0].y+"</li><li>"+"Piece Offset: "+this.x+","+this.y+"</li><li>"+"Piece Container Offset: "+this.getOffsetFromOrigin().x+","+this.getOffsetFromOrigin().y+"</li><li>"+"Distance From Match: "+Math.abs(e[0].x-e[1].x)+","+Math.abs(e[0].y-e[1].y)+"</li><li>"+"Angle, Radius: "+this.angle+", "+this.radius+"</li></ul>";return t};var PuzzleBox=PuzzleBox||{};PuzzleBox.Puzzle=function(e){this.id=e.id||"puzzleRoot",this._pieceContainers=new Array,this._pieces=new Array,this._selectedPiece=null,this._hint=null,this._data=e||{},this._background=null,this._queue=new createjs.LoadQueue,this._View=null,this._Controller=null,this._options={allowRotate:!0,allowHint:!0,showLabels:!0,snapAll:!1,snapRadius:50,showTitle:!0},typeof e.options=="object"&&(this._options=$.extend(this._options,e.options)),this.pieceContainerAdded=new PuzzleBox.Event(this),this.pieceContainerRemoved=new PuzzleBox.Event(this),this.selectedPieceChanged=new PuzzleBox.Event(this),this.pointsConnected=new PuzzleBox.Event(this),this.pieceAdded=new PuzzleBox.Event(this),this.pieceRemoved=new PuzzleBox.Event(this),this.puzzleComplete=new PuzzleBox.Event(this),this.backgroundSet=new PuzzleBox.Event(this),this.puzzleLoaded=new PuzzleBox.Event(this),this.fileLoaded=new PuzzleBox.Event(this),this.progressChange=new PuzzleBox.Event(this),this.initialize()};var pz=PuzzleBox.Puzzle.prototype;pz.initialize=function(){$("body").addClass(this._data.id),this._queue.installPlugin(createjs.Sound),createjs.Sound.registerPlugins([createjs.WebAudioPlugin,createjs.HTMLAudioPlugin,createjs.FlashPlugin]);var e=this;this._queue.addEventListener("complete",function(t){e.puzzleLoaded.notify({event:t})}),this._queue.addEventListener("fileload",function(t){e.fileLoaded.notify({event:t})}),this._queue.addEventListener("progress",function(t){e.progressChange.notify({event:t})}),this._View=new PuzzleBox.PuzzleView(this),this._View.showLoadingWindow(this._data.title,this._data.instructionText,this._data.instructionGif,this._data.instructionMouse),this._Controller=new PuzzleBox.PuzzleController(this,this._View),this.loadPuzzle()},pz.loadPuzzle=function(){var e=this._data;this._queue.loadManifest(e.background),this._queue.loadManifest(e.hint);var t=function(e){var t=[];for(var n=0;n<e.length;n++)e[n].state="neutral",t.push(e[n]),e[n].hover!==null&&t.push({id:e[n].id+"-hover",src:e[n].hover,state:"hover"}),e[n].selected!==null&&t.push({id:e[n].id+"-selected",src:e[n].selected,state:"selected"});return t}(e.pieces);this._queue.loadManifest(t);for(var n=0;n<e.sounds.length;n++){var r=e.sounds[n];this._queue.loadFile({id:r.id,src:r.mp3+"|"+r.ogg})}},pz.setupPuzzle=function(){var e=this._queue.getResult("background");this.setBackground(e),this._options.allowHint&&(this.setHint(this._queue.getResult("hint")),this._View.enableHintButton()),this._options.snapAll&&this._View.enableValidateButton();while((p=this._pieces.pop())!=null){p.imgNeutral=this._queue.getResult(p.name),p.imgHover=this._queue.getResult(p.name+"-hover"),p.imgSelected=this._queue.getResult(p.name+"-selected");var t={},n=this.getBackgroundSize();t.pieces=[p];if(typeof this._options.placementBox=="object"&&!p.fixed){var r=this._options.placementBox;t.x=r.x+p.regX+Math.round(Math.random()*(r.width-p.image.width)),t.y=r.y+p.regY+Math.round(Math.random()*(r.height-p.image.height))}else t.x=p.regX+Math.round(Math.random()*(this._View.getCanvas().width-p.image.width)),t.y=p.regY+Math.round(Math.random()*(this._View.getCanvas().height-p.image.height));this.addPieceContainer(new PuzzleBox.PieceContainer(t))}var i=this._data;if(this._options.snapAll){for(var s=0;s<i.matches.length;s++)for(var o=0;o<i.pieces.length;o++){var u=new PuzzleBox.Point(this.getPieceByName(i.matches[s].piece),i.matches[s].x,i.matches[s].y);u.setMatch(new PuzzleBox.Point(this.getPieceByName(i.pieces[o].id),0,0))}var a=new Array;for(var s=0;s<i.success.length;s++){var f=this.getPieceByName(i.success[s][0].piece),l=this.getPieceByName(i.success[s][1].piece),c={id:f.name,x:l.boundary.width/2+i.success[s][1].x,y:l.boundary.height/2+i.success[s][1].y};a.push(c)}this.setSuccessState(a)}else for(var s=0;s<i.matches.length;s++){var u=new PuzzleBox.Point(this.getPieceByName(i.matches[s][0].piece),i.matches[s][0].x,i.matches[s][0].y);u.setMatch(new PuzzleBox.Point(this.getPieceByName(i.matches[s][1].piece),i.matches[s][1].x,i.matches[s][1].y))}this.puzzleLoaded.notify({event:{name:"Puzzle Loaded"}})},pz.getPieceContainers=function(){return this._pieceContainers},pz.getPieceByName=function(e){for(var t=0;t<this._pieceContainers.length;t++)for(var n=0;n<this._pieceContainers[t]._pieces.length;n++)if(this._pieceContainers[t]._pieces[n].name==e)return this._pieceContainers[t]._pieces[n];return!1},pz.getContainerByPieceName=function(e){for(var t=0;t<this._pieceContainers.length;t++)for(var n=0;n<this._pieceContainers[t]._pieces.length;n++)if(this._pieceContainers[t]._pieces[n].name==e)return this._pieceContainers[t];return!1},pz.getSelectedPiece=function(){return this._selectedPiece},pz.getBackgroundSize=function(){return{width:this._background.image.width,height:this._background.image.width}},pz.setSelectedPiece=function(e){var t=this._selectedPiece;t!==null&&t.resetPiece(!0),this._selectedPiece=e,e!==null&&this._selectedPiece.selectPiece(),this.selectedPieceChanged.notify({oldPiece:t,newPiece:this._selectedPiece,event:{type:"selectchange"}})},pz.setBackground=function(e){return this._background=new createjs.Bitmap(e),this._background.type="background",this.backgroundSet.notify({bg:this._background,event:{type:"backgroundset"}}),this},pz.setHint=function(e){return this._hint=new createjs.Bitmap(e),this._hint.alpha=0,this._hint.type="hint",this},pz.setSuccessState=function(e){return this._successState=e,this},pz.addPieceContainer=function(e){this._pieceContainers.push(e),e._puzzle=this,this.pieceContainerAdded.notify({pieceContainer:e,event:{type:"addpiececontainer"}})},pz.removePieceContainer=function(e){for(var t=0;t<this._pieceContainers.length;t++)if(this._pieceContainers[t].id==e.id)return this._pieceContainers.remove(t),e.isSelected()&&(this._selectedPiece=null),this.pieceContainerRemoved.notify({pieceContainer:e,event:{type:"removepiececontainer"}}),!0;return!1},pz.connectPointWithMatch=function(e){var t=e.getMatch(),n=e;return this.mergePieceContainers(n.getPiece().getParentPieceContainer(),t.getPiece().getParentPieceContainer(),e.getMatch()),n.getPiece().removePoint(n),t.getPiece().removePoint(t),e=null,n.getPiece().getParentPieceContainer().resetPiece(!0),this.pointsConnected.notify({pieceContainer:n.getPiece().getParentPieceContainer(),event:{type:"pointsconnected"}}),this.isComplete()&&this.puzzleComplete.notify({pieceContainer:n.getPiece().getParentPieceContainer(),event:{type:"puzzlecomplete"}}),n.piece.getParentPieceContainer()},pz.mergePieceContainers=function(e,t,n){var r=e.getPieces(),i=null,s={x:n.x+n.piece.x-(n.getMatch().x+n.getMatch().piece.x),y:n.y+n.piece.y-(n.getMatch().y+n.getMatch().piece.y)};while((i=r.pop())!=null)i.set({x:s.x+i.x,y:s.y+i.y}),i.setBoundary(),t.addPiece(i),t.setBoundary(),e.removePiece(i);return this.removePieceContainer(e),this},pz.deselectPieces=function(){if(this._selectedPiece!==null){this._selectedPiece.resetPiece(!0);var e=this._selectedPiece;this._selectedPiece=null,this.selectedPieceChanged.notify({oldPiece:e,event:{type:"selectchange"}})}return this},pz.isInSuccessState=function(){var e=0;if(typeof this._successState=="undefined")return!1;for(var t=0;t<this._successState.length;t++){var n=this._successState[t],r=this.getContainerByPieceName(n.id);e+=Math.abs(n.x-r.x),e+=Math.abs(n.y-r.y)}return e>20?!1:!0},pz.isComplete=function(){return this._pieceContainers.length==1?!0:!1},pz.toString=function(){var e="<ul>";return this._selectedPiece!==null?e+="<li class='selected-piece'>"+this._selectedPiece.toString()+"</li>":e+="<li class='no-pieces'>No pieces have been selected.</li>",e+="</ul>",e};var PuzzleBox=PuzzleBox||{};PuzzleBox.PuzzleView=function(e){if(typeof t=="undefined"){var t=document.getElementById("puzzleCanvas");t==null&&(t=document.createElement("canvas"),t.id="puzzleCanvas",document.getElementsByTagName("body")[0].appendChild(t))}createjs.Ticker.setPaused(!0),this._canvas=t,this._animating=!1,this._aspectRatio=16/9,this._model=e,this._stage=new createjs.Stage(this._canvas),this.clickedOnPiece=new PuzzleBox.Event(this),this.clickedOnNothing=new PuzzleBox.Event(this),this.mouseOverPiece=new PuzzleBox.Event(this),this.mouseOutPiece=new PuzzleBox.Event(this),this.dragPiece=new PuzzleBox.Event(this),this.dragRotateHandle=new PuzzleBox.Event(this),this.releasePiece=new PuzzleBox.Event(this),this.clickStartButton=new PuzzleBox.Event(this),this.validationRequested=new PuzzleBox.Event(this),this.Components={pieceLabel:$("#piece-label"),hintToggle:$("#hint-toggle"),validateButton:$("#validate-btn"),progressBar:$("#progress-bar"),startButton:$("#start"),loadingLabel:$("#loading-label"),canvasHolder:$("#fullscreen"),loadingWindow:$("#loading-window"),loadingTitle:$("#puzzle-title"),loadingGif:$("#puzzle-gif"),loadingIntro:$("#puzzle-intro"),loadingGestures:$("#puzzle-gestures"),notifyWindow:$("#ntfy-window"),notifyTitle:$("#ntfy-title"),notifyMessage:$("#ntfy-message"),notifyClose:$("#ntfy-close")};var n=this;this.Components.startButton.bind("click",function(e){n.initialize(),n.clickStartButton.notify({event:e})})};var pv=PuzzleBox.PuzzleView.prototype;pv.initialize=function(){this._stage._needsUpdate=!1,this._stage.mouseEventsEnabled=!0,this._stage.enableMouseOver(1e3),this._stage.mouseMoveOutside=!0,this._hoveredPiece=null;var e=this;createjs.Touch.enable(this._stage),createjs.Ticker.setPaused(!1),document.onselectstart=function(){return!1},this._stage.addEventListener("stagemousemove",function(t){var n=e._stage.getObjectUnderPoint(t.stageX/e._stage.scaleX,t.stageY/e._stage.scaleY);n==null&&(n={type:"background"});if(n.type!=="background"&&n.type!=="hint")n.type=="piece"&&(n=n.parent),e._hoveredPiece==null&&!n.isFixed()&&(e._hoveredPiece=n,document.body.style.cursor="pointer",e.mouseOverPiece.notify({event:t,pieceContainer:n}));else if(e._hoveredPiece!==null){var r=e._hoveredPiece;e._model.getSelectedPiece()!==null&&e._model._options.allowRotate?document.body.style.cursor="url(https://d396qusza40orc.cloudfront.net/dino101%2Fpuzzle%2Fassets%2Fcommon%2Frotate3.cur),default":document.body.style.cursor="default",e.mouseOutPiece.notify({event:t,pieceContainer:r}),e._hoveredPiece=null}}),this._stage.addEventListener("dblclick",function(t){var n=e._stage.getObjectUnderPoint(t.stageX/e._stage.scaleX,t.stageY/e._stage.scaleY);if(n.type=="background"||n.type=="hint")e.clickedOnNothing.notify({event:t}),document.body.style.cursor="default"}),this._stage.addEventListener("mousedown",function(t){var n=(new Date).getTime(),r=e._stage,i=r.getObjectUnderPoint(r.mouseX/r.scaleX,r.mouseY/r.scaleX),s=i.parent,o={x:s.x-t.stageX/r.scaleX,y:s.y-t.stageY/r.scaleY};if(i.type==null||i.type=="background"||i.type=="hint"){t.addEventListener("mouseup",function(t){var r=(new Date).getTime();r-n<250&&(e.clickedOnNothing.notify({event:t}),document.body.style.cursor="default")});var u=e._model.getSelectedPiece();if(u!==null&&e._model._options.allowRotate){var a=u.rotation;o={x:t.stageX/r.scaleX,y:t.stageY/r.scaleY},t.addEventListener("mousemove",function(t){t.offset=o,t.start=a,t.stageX=t.stageX/r.scaleX,t.stageY=t.stageY/r.scaleY,e.dragRotateHandle.notify({event:t,pieceContainer:u})})}}else e.clickedOnPiece.notify({event:t,piece:i}),i.type!==null&&i.type=="piece"&&!i.parent.isFixed()&&t.addEventListener("mousemove",function(t){t.offset=o,document.body.style.cursor="move",t.stageX=t.stageX/r.scaleX,t.stageY=t.stageY/r.scaleY,e.dragPiece.notify({event:t,pieceContainer:s})}),t.addEventListener("mouseup",function(t){document.body.style.cursor="pointer",e.releasePiece.notify({event:t,pieceContainer:s})})}),createjs.Ticker.setFPS(24),createjs.Ticker.addEventListener("tick",this.update.bind(this)),window.onblur=function(){createjs.Ticker.setPaused(!0),createjs.Ticker.removeEventListener("tick",e.update.bind(e))},window.onfocus=function(){createjs.Ticker.setPaused(!1),createjs.Ticker.addEventListener("tick",e.update.bind(e))},this.Components.hintToggle.bind("click",function(t){e.showHint()}),this.Components.validateButton.bind("click",function(t){e.validationRequested.notify({event:t})}),this.Components.notifyClose.bind("click",function(t){e.dismissNotification(e.Components.notifyWindow)})},pv.getStage=function(){return this._stage},pv.getCanvas=function(){return this._canvas},pv.getAspectRatio=function(){return this._aspectRatio},pv.setAspectRatio=function(e){this._aspectRatio=e},pv.updateProgressBar=function(e){this.Components.progressBar.css("width",e+"%")},pv.enableStartButton=function(){this.Components.startButton.text("Start"),this.Components.startButton.attr("class","btn btn-start")},pv.update=function(e){!createjs.Ticker.getPaused()&&(this._stage._needsUpdate||this._animating)&&(this._stage._needsUpdate=!1,this._stage.update(e))},pv.triggerRefresh=function(){this._stage._needsUpdate=!0},pv.showPieceLabel=function(e){this.Components.pieceLabel.text(e.getPieceString()),this.Components.pieceLabel.attr("class","active")},pv.hidePieceLabel=function(){this.Components.pieceLabel.attr("class","inactive")},pv.showHintToggle=function(){this.Components.hintToggle.show()},pv.hideHintToggle=function(){this.Components.hintToggle.hide()},pv.addTitle=function(e){this.Components.canvasHolder.append('<h1 id="overall-title" class="species-heading">'+e+"</h1>")},pv.showLoadingWindow=function(e,t,n,r){this.Components.loadingTitle.text(e),this.Components.loadingIntro.html(t);for(var i=0;i<n.length;i++)$(".puzzle-gif-holder").append("<img src='"+n[i]+"' />");n.length>1&&$(function(){$(".puzzle-gif-holder img:gt(0)").hide(),setInterval(function(){$(".puzzle-gif-holder :first-child").fadeOut().next("img").fadeIn().end().appendTo(".puzzle-gif-holder")},3e3)}),r?this.Components.loadingGestures.attr("src",r):this.Components.loadingGestures.hide()},pv.hideLoadingWindow=function(){this.Components.canvasHolder.addClass("started"),this.Components.loadingWindow.removeClass("active")},pv.updatePieceContainer=function(e){var t=e.getPieceContainerBoundary();e.cacheCanvas?t.left==e._cacheOffsetX&&t.top==e._cacheOffsetY&&t.width==e.cacheCanvas.width&&t.height==e.cacheCanvas.height?e.updateCache():(e.cache(t.left,t.top,t.width,t.height),debug.log("boundary doesn't match cache, updating")):e.cache(t.left,t.top,t.width,t.height),this._stage._needsUpdate=!0},pv.resizePuzzle=function(e,t){typeof this._stage.scaleX=="undefined"&&(this._stage.scaleX=this._stage.scaleY=1),this._canvas.width=e,this._canvas.height=Math.round(e/this._aspectRatio),this.Components.canvasHolder.width(e+"px"),this.Components.canvasHolder.height(Math.round(e/this._aspectRatio)+"px");var n=this._model._background.image.width,r=1;n>0&&(r=this._canvas.width/n),this._stage.scaleX=this._stage.scaleY=this._stage.scale=r,this._stage._needsUpdate=!0},pv.resizeHolder=function(e){this.Components.canvasHolder.width(e+"px"),this.Components.canvasHolder.height(Math.round(e/this._aspectRatio)+"px")},pv.removePieceContainers=function(){for(var e=0;e<this._stage.children.length;e++){var t=this._stage.children[e];t.type!==null&&t.type=="piece-container"&&this._stage.removeChildAt(e)}},pv.showHint=function(){var e=this;!this._animating&&this._model._options.allowHint&&(this._animating=!0,createjs.Tween.get(this._model._hint).to({alpha:.25},500).wait(5e3).call(e.hideHint.bind(e)))},pv.hideHint=function(){var e=this;this._model._options.allowHint&&createjs.Tween.get(this._model._hint).to({alpha:0},500).call(function(){e._animating=!1})},pv.enableValidateButton=function(){this.Components.validateButton.removeClass("ctl-disabled")},pv.enableHintButton=function(){this.Components.hintToggle.removeClass("ctl-disabled")},pv.showBackground=function(e){this.Components.canvasHolder.css("background-image","url("+e+")")},pv.notifySuccess=function(){this.showNotification("Correct!","You have successfully built the Dinosauria Tree.","success")},pv.notifyFail=function(){this.showNotification("Incorrect!","Not all the pieces are in their correct position on the Dinosauria Tree.","fail")},pv.showNotification=function(e,t,n){this.Components.notifyTitle.text(e),this.Components.notifyMessage.text(t),this.Components.notifyWindow.attr("class",n+" active");var r=this.Components.canvasHolder.height()/2-this.Components.notifyWindow.height()/2;this.Components.notifyWindow.css("top",r+"px")},pv.dismissNotification=function(e){e.removeAttr("style"),e.removeClass("active")},pv.buildPuzzle=function(){this.removePieceContainers(),this._stage._needsUpdate=!0,this._model._background!==null&&this._model._options.allowRotate&&this._stage.addChild(this._model._background),this._model._hint!==null&&this._model._options.allowHint&&this._stage.addChild(this._model._hint);for(var e=0;e<this._model._pieceContainers.length;e++)if(this._model._pieceContainers[e].isFixed()){this._model._pieceContainers[e].sortPieces();for(var t=0;t<this._model._pieceContainers[e]._pieces.length;t++)this._model._pieceContainers[e].addChild(this._model._pieceContainers[e]._pieces[t]);this._stage.addChild(this._model._pieceContainers[e])}for(var e=0;e<this._model._pieceContainers.length;e++)if(!this._model._pieceContainers[e].isFixed()){this._model._pieceContainers[e].sortPieces();for(var t=0;t<this._model._pieceContainers[e]._pieces.length;t++)this._model._pieceContainers[e].addChild(this._model._pieceContainers[e]._pieces[t]);this._stage.addChild(this._model._pieceContainers[e])}this._stage._needsUpdate=!0};var PuzzleBox=PuzzleBox||{};PuzzleBox.PuzzleController=function(e,t){this._model=e,this._view=t,this.initialize()};var ctrl=PuzzleBox.PuzzleController.prototype;ctrl.initialize=function(){this._view.clickedOnPiece.attach(this.pressedOnPieceContainer.bind(this)),this._view.clickedOnNothing.attach(this.pressedOnNothing.bind(this)),this._view.mouseOverPiece.attach(this.hoveredOver.bind(this)),this._view.mouseOutPiece.attach(this.hoveredOut.bind(this)),this._view.releasePiece.attach(this.pieceContainerReleased.bind(this)),this._view.dragPiece.attach(this.pieceContainerDragged
.bind(this)),this._view.dragRotateHandle.attach(this.rotateHandleDragged.bind(this)),this._view.clickStartButton.attach(this.startPuzzle.bind(this)),this._view.validationRequested.attach(this.handleValidation.bind(this)),this._model.fileLoaded.attach(this.handleFileLoad.bind(this)),this._model.progressChange.attach(this.progressChanged.bind(this)),this._model.puzzleLoaded.attach(this.loadingComplete.bind(this)),this._model.pieceContainerAdded.attach(this.pieceContainerAdded.bind(this)),this._model.pieceContainerRemoved.attach(this.pieceContainerRemoved.bind(this)),this._model.pieceAdded.attach(this.pieceAdded.bind(this)),this._model.pieceRemoved.attach(this.pieceRemoved.bind(this)),this._model.selectedPieceChanged.attach(this.selectedPieceChanged.bind(this)),this._model.pointsConnected.attach(this.pointsConnected.bind(this)),this._model.puzzleComplete.attach(this.puzzleCompleted.bind(this)),this._model.backgroundSet.attach(this.backgroundSet.bind(this))},ctrl.handleFileLoad=function(e,t){var n=t.event.item,r=n.type;n.id==="background"&&(this._view.setAspectRatio(t.event.result.width/t.event.result.height),this._view.resizeHolder($(window).width()),this._view.showBackground(n.src)),r==createjs.LoadQueue.IMAGE&&n.state=="neutral"&&this._model._pieces.push(new PuzzleBox.Piece({img:t.event.result,name:n.id,displayName:n.name,fixed:n.fixed,parentX:n.x,parentY:n.y,zindex:n.zindex,scale:n.scale||1})),debug.log("File loaded",t.event)},ctrl.handleValidation=function(e,t){this._model.isInSuccessState()?this._view.notifySuccess():this._view.notifyFail()},ctrl.progressChanged=function(e,t){var n=t.event,r=Math.round(n.loaded*100);this._view.updateProgressBar(r)},ctrl.startPuzzle=function(){this._view.hideLoadingWindow(),this._model.setupPuzzle(),this._model._options.showTitle&&this._view.addTitle(this._model._data.title),this._view.buildPuzzle(),this._model._options.allowHint&&this._view.showHintToggle(),this._view.resizePuzzle(window.innerWidth,window.innerHeight)},ctrl.loadingComplete=function(){this._view.enableStartButton()},ctrl.pressedOnNothing=function(e,t){this._model.deselectPieces(),debug.log("Clicked on nothing")},ctrl.pressedOnPieceContainer=function(e,t){var n=t.piece;t.piece.type=="piece"&&(n=t.piece.getParentPieceContainer()),n.type=="piece-container"&&(n.isFixed()||this._model.setSelectedPiece(n)),debug.log(t,"Clicked on an object")},ctrl.pieceContainerAdded=function(e,t){this._view.buildPuzzle(),debug.log(t.pieceContainer,"Added piece container to stage")},ctrl.pieceContainerRemoved=function(e,t){this._view.updatePieceContainer(t.pieceContainer),debug.log(t.pieceContainer,"Removed piece container from stage")},ctrl.pieceAdded=function(e,t){t.piece.parent.updatePoints(),createjs.Sound.play("snap").setVolume(.5),this._view.buildPuzzle(),debug.log(t,"Added piece to container")},ctrl.pieceRemoved=function(e,t){this._view.buildPuzzle(),debug.log(t,"Removed piece from container")},ctrl.selectedPieceChanged=function(e,t){typeof t.oldPiece!="undefined"&&t.oldPiece!==null&&this._view.updatePieceContainer(t.oldPiece),typeof t.newPiece!="undefined"&&t.newPiece!==null?(this._view.updatePieceContainer(t.newPiece),this._model._options.showLabels&&this._view.showPieceLabel(t.newPiece)):this._model._options.showLabels&&this._view.hidePieceLabel(),debug.log("Selected piece changed")},ctrl.pointsConnected=function(e,t){this._view.updatePieceContainer(t.pieceContainer),this._model.setSelectedPiece(null),debug.log(t,"Points connected")},ctrl.rotateHandleDragged=function(e,t){if(!this._model._options.allowRotate)return;t.pieceContainer.rotatePiece(t.event),this._view.triggerRefresh()},ctrl.pieceContainerDragged=function(e,t){t.pieceContainer.movePiece(t.event.stageX+t.event.offset.x,t.event.stageY+t.event.offset.y).updatePointsOffset().snapToMatch(),this._view.updatePieceContainer(t.pieceContainer)},ctrl.pieceContainerReleased=function(e,t){t.pieceContainer.updatePointsOffset(),this._model._options.snapAll?t.pieceContainer.snapPiece():t.pieceContainer.matchPieces(),this._view.updatePieceContainer(t.pieceContainer),debug.log(t,"Piece released")},ctrl.hoveredOut=function(e,t){t.pieceContainer.resetPiece(),this._view.updatePieceContainer(t.pieceContainer)},ctrl.hoveredOver=function(e,t){t.pieceContainer.hoverPiece(),this._view.updatePieceContainer(t.pieceContainer)},ctrl.puzzleCompleted=function(e,t){createjs.Sound.play("success"),this._view.hideHintToggle()},ctrl.backgroundSet=function(e,t){this._view.setAspectRatio(t.bg.image.width/t.bg.image.height),this._view.resizePuzzle(t.bg.image.width,t.bg.image.height)};